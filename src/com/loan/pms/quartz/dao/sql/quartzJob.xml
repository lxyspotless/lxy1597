<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.loan.pms.quartz.dao.QuartzJobDao">
    <select id="lockJob" statementType="CALLABLE" parameterType="com.loan.pms.quartz.dto.QuartzJobLockDTO" >
       	<![CDATA[
       		{call PROC_QUARTZ_LOCK_JOB(#{targetId,mode=IN,jdbcType=VARCHAR},#{targetType,mode=IN,jdbcType=VARCHAR},
       			#{lockedDate,mode=IN,jdbcType=TIMESTAMP},#{expiredDate,mode=IN,jdbcType=TIMESTAMP},
       			#{isLocked,mode=OUT,jdbcType=VARCHAR,javaType=java.lang.String})}
       	]]>
    </select>
    
    <update id="expireJob" parameterType="com.loan.pms.quartz.dto.QuartzJobLockDTO">
    	merge into pms_quartz_job_lock
    	using dual x
    	on(target_id = #{targetId} and target_type = #{targetType})
    	when matched then
    		update
    			set locked_date = #{lockedDate},
    				expired_date = #{expiredDate}
    	when not matched then
    		insert (
    			target_id,
    			target_type,
    			locked_date,
    			expired_date,
    			is_effective
    		)
    		values
    		(
    			#{targetId},
    			#{targetType},
    			#{lockedDate,jdbcType=TIMESTAMP},
    			#{expiredDate,jdbcType=TIMESTAMP},
    			'Y'
    		)
    </update>
</mapper>